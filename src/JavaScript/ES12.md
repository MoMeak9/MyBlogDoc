---
date: 2022-04-01
category:
- å‰ç«¯
- JavaScript
---

# ES 12 æ–°ç‰¹æ€§

## é€»è¾‘èµ‹å€¼æ“ä½œç¬¦

é€»è¾‘èµ‹å€¼æ“ä½œç¬¦å°†é€»è¾‘æ“ä½œ(`&&`ã€`||`æˆ–`??`)ä¸Žèµ‹å€¼è¡¨è¾¾å¼ç»„åˆåœ¨ä¸€èµ·ã€‚

```js
x ||= y;
x || (x = y);

x &&= y;
x && (x = y);


x ??= y;
x ?? (x = y);
```

**å¸¦æœ‰`&&`çš„é€»è¾‘èµ‹å€¼æ“ä½œç¬¦**

```js
let x = 1;
let y = 2;
x &&= y;
console.log(x); // 2
```

`x &&= y` ç­‰ä»·äºŽ `x && (x = y)`ã€‚

æˆ–è€…ç­‰ä»·äºŽ

```js
if(x) {
  x = y
}
```

å› ä¸º`x`æ˜¯ä¸€ä¸ªçœŸå€¼ï¼Œæ‰€ä»¥å®ƒè¢«èµ‹å€¼ä¸º`y`ï¼Œå³`2`ã€‚

### **å¸¦æœ‰`||`çš„é€»è¾‘èµ‹å€¼æ“ä½œç¬¦**

```js
let x = 1;
let y = 2;
x ||= y;
console.log(x); // 1
```

`x ||= y` ç­‰ä»·äºŽ `x || (x = y)`ã€‚

è¿™æ„å‘³ç€èµ‹å€¼æ“ä½œåªåœ¨`x`ä¸ºè™šå€¼æ—¶æ‰ä¼šå‘ç”Ÿã€‚åœ¨æˆ‘ä»¬çš„ä»£ç ä¸­ï¼Œ`x`åŒ…å«`1`ï¼Œè¿™æ˜¯ä¸€ä¸ªçœŸå€¼ï¼Œå› æ­¤ï¼Œèµ‹å€¼ä¸ä¼šå‘ç”Ÿã€‚è¿™å°±æ˜¯æˆ‘ä»¬çš„ä»£ç åœ¨æŽ§åˆ¶å°ä¸­æ‰“å°`1`çš„åŽŸå› ã€‚

ç®€å•åœ°è¯´

```js
const updateID = user => {

  // æˆ‘ä»¬å¯ä»¥è¿™æ ·åš
  if (!user.id) user.id = 1

  // æˆ–è€…è¿™æ ·
  user.id = user.id || 1

  // æˆ–è€…è¿™æ ·
  user.id ||= 1
}
```

### **å¸¦æœ‰`??`çš„é€»è¾‘èµ‹å€¼æ“ä½œç¬¦**

`??` åœ¨ JS ä¸­ä¸“é—¨æ£€æŸ¥ä¸€ä¸ªå€¼æ˜¯å¦ä¸º `null` æˆ–`undefined`ã€‚

```js
let a;
let b = a ?? 5;
console.log(b); // 5
```

åœ¨ç¬¬äºŒè¡Œï¼Œ`let b = a ?? 5`ï¼Œå¦‚æžœ`a`çš„å€¼ä¸º`null` æˆ–`undefined`ï¼Œ`??`æ±‚å€¼å¹¶èµ‹å€¼ç»™`b`ã€‚

çŽ°åœ¨è€ƒè™‘`??` å’Œ`==`ã€‚

```js
let x;
let y = 2;
x ??= y;
console.log(x); // 2
x ??= y` ç­‰ä»·äºŽ `x = x ?? (x=y)
```

## æ•°å­—åˆ†éš”ç¬¦

å®ƒå…è®¸æˆ‘ä»¬åœ¨æ•°å­—ä¹‹é—´æ·»åŠ ä¸‹åˆ’çº¿(`_`)å­—ç¬¦ï¼Œä½¿æ•°å­—æ›´å…·å¯è¯»æ€§ã€‚

ä¾‹å¦‚

```js
const num = 100000000
```

è¢«0çš„æ•°é‡æ‰€è¿·æƒ‘

åˆ†éš”ç¬¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼š

```js
const num = 100_000_000
```

åˆ†éš”ç¬¦å¯ä»¥ç”¨äºŽæ•°å­—çš„æ•´æ•°éƒ¨åˆ†å’Œå°æ•°éƒ¨åˆ†ã€‚

```js
const num = 1_000_000.123_456
```

åˆ†éš”ç¬¦ä¸ä»…å¯ä»¥ç”¨åœ¨æ•´æ•°å’Œæµ®ç‚¹æ•°ä¸­ï¼Œä¹Ÿå¯ä»¥ç”¨åœ¨äºŒè¿›åˆ¶ã€åå…­è¿›åˆ¶ã€å…«è¿›åˆ¶å­—é¢é‡ä¸­ã€‚

åˆ†éš”ç¬¦ä¹Ÿé€‚ç”¨äºŽBigIntæ•°å­—ã€‚

```js
const trillion = 1000_000_000_000n;
console.log(trillion.toString()); // "1000000000000"
```

åˆ†éš”ç¬¦åªæ˜¯ä¸ºäº†å¯è¯»æ€§ã€‚æ‰€ä»¥ï¼Œå®ƒå¯ä»¥æ”¾åœ¨æ•°å­—å†…çš„ä»»ä½•åœ°æ–¹ã€‚

```js
const amount = 178_00; // 00 after _ for cents.
```

## Promise.any ä¸Ž AggregateError

`Promise.any()`è¿”å›žç¬¬ä¸€ä¸ªå®Œæˆçš„promiseçš„å€¼ã€‚å¦‚æžœæ‰€æœ‰ä¼ é€’ç»™`Promise.any()`ä½œä¸ºå‚æ•°(ä½œä¸ºæ•°ç»„)çš„Promiseéƒ½è¢«æ‹’ç»ï¼Œåˆ™æŠ›å‡ºä¸€ä¸ª"`AggregateError`"å¼‚å¸¸ã€‚

AggregateError`æ˜¯ä¸€ä¸ªæ–°çš„Errorå­ç±»ï¼Œå®ƒå¯¹å•ä¸ªé”™è¯¯è¿›è¡Œåˆ†ç»„ã€‚æ¯ä¸ªAggregateErrorå®žä¾‹éƒ½åŒ…å«ä¸€ä¸ªå¯¹å¼‚å¸¸æ•°ç»„çš„å¼•ç”¨ã€‚

è€ƒè™‘ä¸‹é¢ä¾‹å­ï¼š

ä¸‹é¢æˆ‘ä»¬æœ‰3ä¸ª promiseï¼Œå®ƒä»¬æ˜¯éšæœºçš„ã€‚

```js
const p1 = new Promise((resolve, reject) => {
  setTimeout(() => resolve("A"), Math.floor(Math.random() * 1000));
});
const p2 = new Promise((resolve, reject) => {
  setTimeout(() => resolve("B"), Math.floor(Math.random() * 1000));
});
const p3 = new Promise((resolve, reject) => {
  setTimeout(() => resolve("C"), Math.floor(Math.random() * 1000));
});
```

åœ¨`p1`, `p2`å’Œ`p3`ä¸­ï¼Œæœ€å…ˆçš„å®Œæˆçš„çš„ç”±`Promise.any()`æ‰§è¡Œã€‚

```js
(async function() {
  const result = await Promise.any([p1, p2, p3]);
  console.log(result); // æ‰“å° "A", "B" æˆ–è€… "C"
})();
```

å¦‚æžœæ‰€æœ‰çš„ promise éƒ½å¤±è´¥äº†?åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ`Promise.any()`æŠ›å‡º`AggregateError`å¼‚å¸¸ã€‚æˆ‘ä»¬éœ€è¦æ•èŽ·å®ƒï¼š

```js
const p = new Promise((resolve, reject) => reject());

try {
  (async function() {
    const result = await Promise.any([p]);
    console.log(result);
  })();
} catch(error) {
  console.log(error.errors);
```

ä¸ºäº†æ¼”ç¤ºçš„ç›®çš„ï¼Œåœ¨`Promise.any()`ä¸­æˆ‘ä»¬åªèƒ½å®ƒä¸€ä¸ª `promise`ã€‚è€Œè¿™ä¸ª promise æ˜¯å¤±è´¥çš„ã€‚ä¸Šè¿°ä»£ç åœ¨æŽ§åˆ¶å°ä¸­è®°å½•äº†ä»¥ä¸‹é”™è¯¯ã€‚

![å›¾ç‰‡](https://my-doc-1259409954.file.myqcloud.com/MyImages/640)

## String.prototype.replaceAll æ–¹æ³•

`String.prototype.replaceAll()`å…è®¸æˆ‘ä»¬ç”¨ä¸€ä¸ªä¸åŒçš„å€¼æ›¿æ¢å­—ç¬¦ä¸²ä¸­çš„æ‰€æœ‰å­ä¸²å®žä¾‹ï¼Œè€Œä¸éœ€è¦ä½¿ç”¨å…¨å±€æ­£åˆ™è¡¨è¾¾å¼ã€‚

ç›®å‰ï¼ŒJavaScriptå­—ç¬¦ä¸²æœ‰ä¸€ä¸ª`replace()`æ–¹æ³•ã€‚å®ƒå¯ä»¥ç”¨æ¥ç”¨å¦ä¸€ä¸ªå­—ç¬¦ä¸²æ›¿æ¢ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚

```js
const str = "Backbencher sits at the Back";
const newStr = str.replace("Back", "Front");
console.log(newStr); // "Frontbencher sits at the Back"
```

å¦‚æžœè¾“å…¥æ¨¡å¼æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œ`replace()`æ–¹æ³•åªæ›¿æ¢ç¬¬ä¸€æ¬¡å‡ºçŽ°çš„å†…å®¹ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆåœ¨ä»£ç ä¸­ï¼Œ"`Back`"çš„ç¬¬äºŒæ¬¡å‡ºçŽ°æ²¡æœ‰è¢«æ›¿æ¢ã€‚

åªæœ‰å°†æ¨¡å¼ä½œä¸ºæ­£åˆ™è¡¨è¾¾å¼æä¾›æ—¶ï¼Œæ‰èƒ½è¿›è¡Œå®Œå…¨æ›¿æ¢ã€‚

```js
const str = "Backbencher sits at the Back";
const newStr = str.replace(/Back/g, "Front");
console.log(newStr); // "Frontbencher sits at the Front"
```

æˆ‘ä»¬æ¥çœ‹å¦ä¸€ä¸ªä¾‹å­

```js
const strWithPlus = '++'
const strWithComma = strWithPlus.replace(/+/g, ', ')
// , , 
```

è¿™ç§æ–¹æ³•éœ€è¦ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ã€‚ç„¶è€Œï¼Œå¤æ‚çš„æ­£åˆ™è¡¨è¾¾å¼å¾€å¾€æ˜¯é”™è¯¯çš„æ¥æºã€‚(æ²¡æœ‰äººå–œæ¬¢RegEx ðŸ˜¬)

è¿˜æœ‰å¦ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨`String.prototype.split()`å’Œ`Array.prototype.join()`æ–¹æ³•

```js
const strWithPlus = '++'
const strWithComma = strWithPlus.split('+').join(', ')
// , , 
```

è¿™ç§æ–¹æ³•é¿å…ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ï¼Œä½†æ˜¯å¿…é¡»å°†å­—ç¬¦ä¸²æ‹†åˆ†ä¸ºå•ç‹¬çš„éƒ¨åˆ†(å•è¯)ï¼Œå°†å…¶è½¬æ¢ä¸ºä¸€ä¸ªæ•°ç»„ï¼Œç„¶åŽå°†æ•°ç»„å…ƒç´ è¿žæŽ¥ä¸ºä¸€ä¸ªæ–°å­—ç¬¦ä¸²ã€‚

`string.prototype.replaceAll()`è§£å†³äº†è¿™äº›é—®é¢˜ï¼Œå¹¶ä¸ºå…¨å±€æ›¿æ¢å­ä¸²æä¾›äº†ç®€å•è€Œæ–¹ä¾¿çš„æ–¹å¼ï¼š

```js
const strWithPlus = '++'
const strWithComma = strWithPlus.replaceAll('+', ', ')
// , ,
```

> æ³¨æ„ï¼šå¦‚æžœä½¿ç”¨å…¨å±€æ­£åˆ™è¡¨è¾¾å¼ä½œä¸ºæŸ¥æ‰¾å€¼ï¼Œé‚£ä¹ˆ`replace`å’Œ`replaceAll`çš„è¡Œä¸ºæ˜¯ä¸€æ ·çš„ã€‚

## WeakRefs ä¸Ž FinalizationRegistry å¯¹è±¡

`WeakRef` æ˜¯å¼±å¼•ç”¨çš„æ„æ€ã€‚å¼±å¼•ç”¨çš„ä¸»è¦ç”¨é€”æ˜¯å®žçŽ°å¤§åž‹å¯¹è±¡çš„**ç¼“å­˜æˆ–æ˜ å°„**ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸å¸Œæœ›é•¿æœŸä¿ç•™å¤§é‡çš„å†…å­˜æ¥ä¿å­˜è¿™ç§å¾ˆå°‘ä½¿ç”¨çš„ç¼“å­˜æˆ–æ˜ å°„ã€‚æˆ‘ä»¬å¯ä»¥è®©å†…å­˜å¾ˆå¿«è¢«åžƒåœ¾å›žæ”¶ï¼Œä»¥åŽå¦‚æžœæˆ‘ä»¬å†æ¬¡éœ€è¦å®ƒï¼Œæˆ‘ä»¬å¯ä»¥ç”Ÿæˆä¸€ä¸ªæ–°çš„ç¼“å­˜ã€‚

JS æ˜¯ä¼šè‡ªåŠ¨åžƒåœ¾æ”¶é›†ã€‚å¦‚æžœä¸€ä¸ªå˜é‡ä¸å†å¯è¾¾ï¼ŒJS åžƒåœ¾æ”¶é›†å™¨å°†è‡ªåŠ¨åˆ é™¤å®ƒã€‚ä½ å¯ä»¥åœ¨MDNä¸­é˜…è¯»æ›´å¤šå…³äºŽ JS åžƒåœ¾æ”¶é›†çš„å†…å®¹ã€‚

WeaseRefsï¼ˆå¼±å¼•ç”¨ï¼‰æä¾›äº†ä¸¤ä¸ªæ–°åŠŸèƒ½ï¼š

- ä½¿ç”¨`WeakRef`ç±»åˆ›å»ºå¯¹å¯¹è±¡çš„å¼±å¼•ç”¨
- ä½¿ç”¨`FinalizationRegistry`ç±»åœ¨åžƒåœ¾æ”¶é›†ä¹‹åŽè¿è¡Œè‡ªå®šä¹‰æ”¶é›†å™¨

ç®€è€Œè¨€ä¹‹ï¼Œ`WeakRef`å…è®¸æˆ‘ä»¬åˆ›å»ºå¯¹è±¡çš„å¼±å¼•ç”¨ï¼Œè¿™äº›å¯¹è±¡æ˜¯å¦ä¸€ä¸ªå¯¹è±¡çš„å±žæ€§å€¼ï¼Œè€Œfinalizerså¯ä»¥ç”¨æ¥ï¼Œé™¤å…¶ä»–å¤–ï¼Œç§»é™¤å¯¹è¢«åžƒåœ¾æ”¶é›†å™¨ "æ¸…ç†"è¿‡çš„å¯¹è±¡çš„å¼•ç”¨ã€‚

åœ¨åˆ›å»ºä½¿ç”¨å†…ç½®ç¼“å­˜çš„è®°å¿†åŒ–ï¼ˆmemoizationï¼‰å‡½æ•°æ—¶ï¼Œå¦‚æžœç¼“å­˜ä¸­å­˜åœ¨ä¼ é€’ç»™å‡½æ•°çš„å‚æ•°çš„è®¡ç®—å€¼ï¼Œè¿™ç§æŠ€æœ¯å¯èƒ½å¾ˆæœ‰ç”¨ï¼ˆå‰ææ˜¯å¯¹è±¡è¢«ç”¨ä½œç¼“å­˜å¯¹è±¡çš„å±žæ€§å€¼ï¼Œä»¥åŠå®ƒä»¬éšåŽè¢«åˆ é™¤çš„é£Žé™©ï¼‰ï¼Œä»¥é˜²æ­¢é‡å¤æ‰§è¡Œå‡½æ•°ã€‚

åœ¨æž„å»ºå†…è”ç¼“å­˜æ—¶

- å¦‚æžœæ²¡æœ‰å†…å­˜æ³„æ¼çš„é£Žé™©ï¼Œé‚£ä¹ˆä½¿ç”¨ `Map`
- å½“ä½¿ç”¨å¯ä»¥éšåŽåˆ é™¤å¯¹è±¡çš„é”®æ—¶ï¼Œä½¿ç”¨ `WeakMap`
- å½“ä½¿ç”¨å¯ä»¥éšåŽåˆ é™¤çš„å€¼å¯¹è±¡æ—¶ï¼Œè¯·å°†`Map`ä¸Ž`WeakRef`ç»“åˆä½¿ç”¨

ææ¡ˆä¸­æœ€åŽä¸€ä¸ªä¾‹å­ï¼š

```js
function makeWeakCached(f) {
  const cache = new Map()
  return key => {
    const ref = cache.get(key)
    if (ref) {
      //     
      const cached = ref.deref()
      if (cached !== undefined) return cached;
    }

    const fresh = f(key)
    //    ( )
    cache.set(key, new WeakRef(fresh))
    return fresh
  };
}

const getImageCached = makeWeakCached(getImage);
```

- `WeakRef`æž„é€ å‡½æ•°æŽ¥å—ä¸€ä¸ªå‚æ•°ï¼Œè¯¥å‚æ•°å¿…é¡»æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶è¿”å›žå¯¹è¯¥å¯¹è±¡çš„å¼±å¼•ç”¨
- WeakRef å®žä¾‹çš„`deref`æ–¹æ³•è¿”å›žä¸¤ä¸ªå€¼ä¸­çš„ä¸€ä¸ªã€‚

åœ¨å†…ç½®ç¼“å­˜çš„æƒ…å†µä¸‹ï¼Œ`finalizer`è¢«è®¾è®¡ä¸ºåœ¨ä¸€ä¸ªå€¼å¯¹è±¡è¢«åžƒåœ¾æ”¶é›†å™¨é”€æ¯åŽå®Œæˆæ¸…ç†è¿‡ç¨‹ï¼Œæˆ–è€…æ›´ç®€å•åœ°è¯´ï¼Œåˆ é™¤å¯¹è¿™æ ·ä¸€ä¸ªå¯¹è±¡çš„å¼±å¼•ç”¨ã€‚

```js
function makeWeakCached(f) {
  const cache = new Map()
  //    -   
  const cleanup = new FinalizationRegistry(key => {
    const ref = cache.get(key)
    if (ref && !ref.deref()) cache.delete(key)
  })

  return key => {
    const ref = cache.get(key)
    if (ref) {
      const cached = ref.deref()
      if (cached !== undefined) return cached
    }

    const fresh = f(key)
    cache.set(key, new WeakRef(fresh))
    //      ( )
    cleanup.register(fresh, key)
    return fresh
  }
}

const getImageCached = makeWeakCached(getImage);
```
